<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>xyzaia.store — Inbox</title>

  <style>
    :root{
      --bg:#0f1b2a;
      --card:#16263a;
      --card2:#0f2136;
      --line: rgba(255,255,255,.12);
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.55);
      --text: #ffffff;
      --accent:#18c6b6;
      --accent2:#0fb5a7;
      --danger:#ff5d5d;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --ui: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--ui);
      background: radial-gradient(1200px 700px at 50% -10%, rgba(24,198,182,.25), transparent 55%),
                  radial-gradient(900px 500px at 0% 0%, rgba(24,198,182,.10), transparent 45%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    .wrap{
      max-width: 1100px;
      margin: 22px auto;
      padding: 0 14px 24px;
    }

    .top{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
      position:relative;
    }

    .top::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(600px 220px at 70% 0%, rgba(24,198,182,.20), transparent 60%);
      pointer-events:none;
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      position:relative;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, var(--accent), #58ffe5);
      color:#05202c;
      font-weight:900;
      box-shadow: 0 12px 25px rgba(24,198,182,.25);
      flex: 0 0 auto;
    }
    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .brand p{
      margin:2px 0 0;
      color: var(--muted2);
      font-size: 12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:800;
    }

    .panel{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.4fr .6fr;
      gap: 12px;
      position:relative;
    }

    .card{
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
    }

    .fieldRow{
      display:flex; gap:10px; align-items:center;
      margin-top: 10px;
    }

    .emailInput{
      flex:1;
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
    }

    .emailInput input{
      border:none;
      outline:none;
      background:transparent;
      color:#fff;
      font-size: 14px;
      width:100%;
      min-width:0;
    }

    .emailInput .suffix{
      color: var(--muted);
      font-size: 13px;
      font-weight:700;
      white-space:nowrap;
    }

    .iconBtn{
      width:44px;
      height:44px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:#fff;
      cursor:pointer;
      display:grid;
      place-items:center;
      transition: transform .08s ease, background .12s ease;
      user-select:none;
    }
    .iconBtn:active{ transform: translateY(1px); }
    .iconBtn:hover{ background: rgba(255,255,255,.06); }

    .actions{
      display:flex;
      gap:10px;
      margin-top: 12px;
      flex-wrap:wrap;
    }

    .btn{
      border:none;
      cursor:pointer;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      letter-spacing:.06em;
      text-transform: uppercase;
      font-size: 12px;
      color:#05202c;
      background: linear-gradient(135deg, var(--accent), #58ffe5);
      box-shadow: 0 12px 24px rgba(24,198,182,.18);
      transition: transform .08s ease, filter .12s ease;
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.03); }
    .btn:active{ transform: translateY(1px); }

    .btnGhost{
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      color:#fff;
      box-shadow:none;
    }

    .btnDanger{
      background: rgba(255,93,93,.14);
      border: 1px solid rgba(255,93,93,.35);
      color:#fff;
      box-shadow:none;
    }

    .mini{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
    }

    .stat{
      flex:1;
      text-align:center;
      background: rgba(0,0,0,.14);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 8px;
    }
    .stat .k{ font-size:11px; color: var(--muted2); font-weight:800; letter-spacing:.10em; text-transform:uppercase; }
    .stat .v{ margin-top:6px; font-size:16px; font-weight:900; color:#fff; }

    .main{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 12px;
    }

    .listHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }

    .listHead .title{
      font-weight: 900;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size: 12px;
      color: var(--muted);
    }

    .hint{
      color: var(--muted2);
      font-size: 12px;
      margin-top: 8px;
      line-height:1.4;
    }

    .list{
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding: 12px;
      min-height: 520px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .items{
      margin-top: 8px;
      overflow:auto;
      padding-right: 4px;
    }

    .item{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid transparent;
      background: rgba(0,0,0,.12);
      cursor:pointer;
      margin-bottom: 10px;
      transition: background .12s ease, border-color .12s ease;
    }
    .item:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.10);
    }
    .item.active{
      background: rgba(24,198,182,.12);
      border-color: rgba(24,198,182,.35);
    }
    .item .subj{
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 6px;
      line-height:1.2;
    }
    .item .meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      color: var(--muted2);
      font-size: 11px;
    }
    .item .prev{
      color: rgba(255,255,255,.70);
      font-size: 12px;
      margin-top: 6px;
      line-height:1.35;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .view{
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      min-height: 520px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .viewHead{
      padding: 14px;
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,.10);
      display:flex;
      gap: 10px;
      justify-content:space-between;
      align-items:flex-start;
    }

    .viewHead .left{
      min-width:0;
    }

    .from{
      font-weight: 900;
      font-size: 14px;
      margin:0;
      word-break: break-word;
    }

    .subject{
      margin: 6px 0 0;
      font-size: 16px;
      font-weight: 900;
      color: #e7fffb;
      word-break: break-word;
    }

    .date{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted2);
      font-family: var(--mono);
    }

    .viewBody{
      padding: 0;
      flex:1;
      background: rgba(0,0,0,.10);
    }

    iframe.mail{
      width:100%;
      height: 100%;
      border: none;
      background:#fff;
    }

    .plain{
      padding: 14px;
      color:#fff;
      line-height:1.55;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap:anywhere;
    }
    .plain a{ color: #7fffee; text-decoration: underline; word-break: break-all; }

    .emptyView{
      padding: 18px;
      color: var(--muted);
      line-height:1.5;
      font-size: 13px;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.75);
      border: 1px solid rgba(255,255,255,.18);
      color:#fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .16s ease, transform .16s ease;
      z-index:999;
      backdrop-filter: blur(8px);
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-3px); }

    /* Mobile behavior: show list OR view */
    .mobileBar{
      display:none;
      gap:10px;
      padding: 10px;
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,.10);
      align-items:center;
    }
    .backBtn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:#fff;
      border-radius: 999px;
      padding: 9px 12px;
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size: 11px;
      cursor:pointer;
    }

    @media (max-width: 980px){
      .panel{ grid-template-columns: 1fr; }
      .main{ grid-template-columns: 1fr; }
      .list{ min-height: 380px; }
      .view{ min-height: 420px; }
      .mobileBar{ display:flex; }
      body[data-mode="list"] .view{ display:none; }
      body[data-mode="view"] .list{ display:none; }
    }
  </style>
</head>

<body data-mode="list">
  <div class="wrap">
    <section class="top">
      <div class="brand">
        <div class="logo">X</div>
        <div>
          <h1>xyzaia.store</h1>
          <p>Quick Inbox · xyzaia.store</p>
        </div>
      </div>

      <div class="panel">
        <div class="card">
          <div style="font-size:12px;color:var(--muted);font-weight:900;letter-spacing:.10em;text-transform:uppercase;">
            Active address
          </div>

          <div class="fieldRow">
            <div class="emailInput">
              <input id="usernameInput" type="text" placeholder="username" autocomplete="off" />
              <div class="suffix" id="domainSuffix">@xyzaia.store</div>
            </div>

            <button class="iconBtn" id="btnCopy" title="Copy email">⎘</button>
          </div>

          <div class="actions">
            <button class="btn btnGhost" id="btnChange">Change</button>
            <button class="btn" id="btnRefresh">Refresh</button>
            <button class="btn btnDanger" id="btnDelete">Delete</button>
          </div>

          <div class="hint" id="hintText">
            Tip: tap <b>Refresh</b> to load inbox. Links inside the email should open normally.
          </div>
        </div>

        <div class="card">
          <div class="mini">
            <div class="stat">
              <div class="k">Emails</div>
              <div class="v" id="statEmails">—</div>
            </div>
            <div class="stat">
              <div class="k">Messages</div>
              <div class="v" id="statMsgs">—</div>
            </div>
          </div>
          <div class="hint" style="margin-top:10px">
            These are local counters for your session (optional).
          </div>
        </div>
      </div>
    </section>

    <section class="main">
      <aside class="list">
        <div class="listHead">
          <div class="title">Inbox</div>
          <button class="btn btnGhost" id="btnGen" style="padding:9px 12px;border-radius:999px;font-size:11px;">Generate</button>
        </div>

        <div class="items" id="msgList">
          <div class="emptyView">No messages yet. Tap <b>Refresh</b>.</div>
        </div>
      </aside>

      <section class="view">
        <div class="mobileBar">
          <button class="backBtn" id="btnBack">Back</button>
          <div style="color:var(--muted);font-weight:900;letter-spacing:.10em;text-transform:uppercase;font-size:12px;">
            Message
          </div>
        </div>

        <div class="viewHead" id="viewHead">
          <div class="left">
            <p class="from" id="viewFrom">Select a message</p>
            <div class="subject" id="viewSubject">—</div>
            <div class="date" id="viewDate">—</div>
          </div>
        </div>

        <div class="viewBody" id="viewBody">
          <div class="emptyView">Select an email from the inbox list.</div>
        </div>
      </section>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // =========================
    // CONFIG (edit these)
    // =========================
    const API_URL = "https://script.google.com/macros/s/AKfycbzpZ5hcmQr6RAjIOvfQAFwRhdF9UvJZY4AH92RfKcYCB4YAXMW0YMjsgS9AhX0rlQY0fg/exec";
    const DOMAIN  = "xyzaia.store"; // change if needed

    // =========================
    // DOM
    // =========================
    const usernameInput = document.getElementById("usernameInput");
    const domainSuffix  = document.getElementById("domainSuffix");
    const btnCopy   = document.getElementById("btnCopy");
    const btnChange = document.getElementById("btnChange");
    const btnRefresh= document.getElementById("btnRefresh");
    const btnDelete = document.getElementById("btnDelete");
    const btnGen    = document.getElementById("btnGen");
    const btnBack   = document.getElementById("btnBack");

    const msgList   = document.getElementById("msgList");
    const viewBody  = document.getElementById("viewBody");
    const viewFrom  = document.getElementById("viewFrom");
    const viewSubject = document.getElementById("viewSubject");
    const viewDate  = document.getElementById("viewDate");

    const toastEl   = document.getElementById("toast");
    const statEmails= document.getElementById("statEmails");
    const statMsgs  = document.getElementById("statMsgs");

    domainSuffix.textContent = "@" + DOMAIN;

    // =========================
    // Utils
    // =========================
    function toast(text){
      toastEl.textContent = text;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function normalizeUsername(value){
      if(!value) return "";
      let v = value.trim().toLowerCase();
      const at = v.indexOf("@");
      if(at !== -1) v = v.slice(0, at);
      v = v.replace(/[^a-z0-9._-]/g, "");
      return v;
    }

    function fullEmail(){
      const u = normalizeUsername(usernameInput.value);
      return u ? `${u}@${DOMAIN}` : "";
    }

    function formatDate(d){
      if(!d) return "—";
      try{
        const dt = new Date(d);
        return dt.toLocaleString("en-US", {
          month:"short", day:"2-digit", year:"numeric",
          hour:"2-digit", minute:"2-digit", hour12:true
        });
      }catch(e){
        return String(d);
      }
    }

    function escapeHtml(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
    }

    function extractSender(from){
      if(!from) return "Unknown";
      const match = from.match(/^"?(.+?)"?\s*<|^(.+?)\s*<|^(.+?)$/);
      return match ? (match[1] || match[2] || match[3] || from).trim() : from;
    }

    function snippetFromMsg(m){
      const plain = (m.body_plain || m.body || "").trim();
      if(plain) return plain.replace(/\s+/g," ").slice(0,140);
      const subj = (m.subject || "").trim();
      return subj ? subj : "(no preview)";
    }

    function linkifyPlain(plain){
      const safe = escapeHtml(plain).replace(/\n/g,"<br>");
      return safe.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
    }

    // =========================
    // HTML Email rendering (iframe)
    // Fix for "blank page" links:
    // - allow-popups-to-escape-sandbox
    // - base target="_blank"
    // - also add click handler inside srcdoc to force window.open on anchor clicks
    // =========================
    function buildIframeSrcdoc(rawHtml){
      const html = String(rawHtml || "");
      const injectHead = `
        <base target="_blank">
        <meta name="referrer" content="no-referrer">
        <style>
          :root { color-scheme: light; }
          html, body { margin:0; padding:0; background:#fff; }
          body { padding:14px; font-family: system-ui,-apple-system,Segoe UI,sans-serif; line-height:1.5; font-size:14px; }
          img, video { max-width:100% !important; height:auto !important; }
          table { max-width:100% !important; width:100% !important; }
          a { word-break: break-all; }
          * { box-sizing: border-box; }
        </style>
        <script>
          // Force anchors to open properly even on some mobile browsers
          document.addEventListener('click', function(e){
            const a = e.target && e.target.closest ? e.target.closest('a') : null;
            if(!a) return;
            const href = a.getAttribute('href');
            if(!href) return;
            // ignore mailto/tel etc
            if(href.startsWith('mailto:') || href.startsWith('tel:')) return;
            e.preventDefault();
            try{
              window.open(href, '_blank', 'noopener,noreferrer');
            }catch(err){
              // fallback
              location.href = href;
            }
          }, true);
        </script>
      `;

      const hasHtmlTag = /<html[\s>]/i.test(html);
      if(hasHtmlTag){
        if (/<head[\s>]/i.test(html)) {
          return html.replace(/<head[^>]*>/i, (m) => m + injectHead);
        }
        return html.replace(/<html[^>]*>/i, (m) => m + `<head>${injectHead}</head>`);
      }

      return `<!doctype html><html><head>${injectHead}</head><body>${html}</body></html>`;
    }

    function looksLikeHtml(s){
      if(!s) return false;
      const t = String(s).trim();
      if(t.length < 30) return false;
      return /<\/?[a-z][\s\S]*>/i.test(t);
    }

    // =========================
    // State
    // =========================
    let MESSAGES = [];
    let ACTIVE_INDEX = -1;

    // session counters (optional)
    let emailCount = 0;
    let msgCount = 0;
    function updateStats(){
      statEmails.textContent = String(emailCount || "—");
      statMsgs.textContent = String(msgCount || "—");
    }

    // Persist username
    const saved = localStorage.getItem("xyzaia_username") || "";
    if(saved) usernameInput.value = saved;

    usernameInput.addEventListener("input", () => {
      const norm = normalizeUsername(usernameInput.value);
      if(usernameInput.value !== norm) usernameInput.value = norm;
      localStorage.setItem("xyzaia_username", norm);
    });

    function setMode(mode){
      document.body.setAttribute("data-mode", mode);
    }

    btnBack.addEventListener("click", () => setMode("list"));

    // =========================
    // UI rendering
    // =========================
    function renderList(){
      msgList.innerHTML = "";

      if(!MESSAGES.length){
        msgList.innerHTML = `<div class="emptyView">No messages yet. Tap <b>Refresh</b>.</div>`;
        return;
      }

      MESSAGES.forEach((m, idx) => {
        const div = document.createElement("div");
        div.className = "item" + (idx === ACTIVE_INDEX ? " active" : "");

        const subj = m.subject || "(no subject)";
        const from = extractSender(m.from);
        const date = formatDate(m.date);
        const prev = snippetFromMsg(m);

        div.innerHTML = `
          <div class="subj">${escapeHtml(subj)}</div>
          <div class="meta">
            <div style="min-width:0;max-width:65%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
              ${escapeHtml(from)}
            </div>
            <div style="flex:0 0 auto;">${escapeHtml(date)}</div>
          </div>
          <div class="prev">${escapeHtml(prev)}</div>
        `;

        div.addEventListener("click", () => {
          ACTIVE_INDEX = idx;
          renderList();
          renderView();
          setMode("view");
        });

        msgList.appendChild(div);
      });
    }

    function renderView(){
      viewBody.innerHTML = "";

      if(ACTIVE_INDEX < 0 || !MESSAGES[ACTIVE_INDEX]){
        viewFrom.textContent = "Select a message";
        viewSubject.textContent = "—";
        viewDate.textContent = "—";
        viewBody.innerHTML = `<div class="emptyView">Select an email from the inbox list.</div>`;
        return;
      }

      const m = MESSAGES[ACTIVE_INDEX];
      viewFrom.textContent = extractSender(m.from);
      viewSubject.textContent = m.subject || "(no subject)";
      viewDate.textContent = formatDate(m.date);

      const html = m.body_html || "";
      const plain = (m.body_plain || m.body || "").trim();

      if(looksLikeHtml(html)){
        const iframe = document.createElement("iframe");
        iframe.className = "mail";

        // IMPORTANT sandbox flags to avoid "blank" on link opens
        iframe.setAttribute("sandbox",
          "allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation-by-user-activation"
        );
        iframe.setAttribute("referrerpolicy", "no-referrer");
        iframe.srcdoc = buildIframeSrcdoc(html);

        viewBody.appendChild(iframe);

        // fallback: if content becomes empty, show plain
        iframe.addEventListener("load", () => {
          try{
            const t = (iframe.contentWindow.document.body.innerText || "").trim();
            if(!t && plain){
              viewBody.innerHTML = `<div class="plain">${linkifyPlain(plain)}</div>`;
            }
          }catch(e){}
        });
      } else {
        viewBody.innerHTML = `<div class="plain">${linkifyPlain(plain || "(empty)")}</div>`;
      }
    }

    // =========================
    // Actions
    // =========================
    function genUsername(){
      const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
      let out = "";
      for(let i=0;i<8;i++) out += chars[Math.floor(Math.random()*chars.length)];
      usernameInput.value = out;
      localStorage.setItem("xyzaia_username", out);
      emailCount++;
      updateStats();
      toast("Generated ✅");
    }

    async function copyEmail(){
      const e = fullEmail();
      if(!e){ toast("Enter username"); return; }
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(e);
        }else{
          const ta = document.createElement("textarea");
          ta.value = e;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }
        toast("Copied ✅");
      }catch(err){
        toast("Copy failed");
      }
    }

    function changeEmail(){
      const cur = normalizeUsername(usernameInput.value) || "";
      const next = prompt("Enter username:", cur);
      if(next === null) return;
      const norm = normalizeUsername(next);
      if(!norm){ toast("Invalid"); return; }
      usernameInput.value = norm;
      localStorage.setItem("xyzaia_username", norm);
      toast("Changed ✅");
    }

    function deleteLocal(){
      // Local clear (hindi totoong delete sa server)
      MESSAGES = [];
      ACTIVE_INDEX = -1;
      msgCount = 0;
      updateStats();
      renderList();
      renderView();
      toast("Cleared");
      setMode("list");
    }

    function loadingList(){
      msgList.innerHTML = `
        <div class="emptyView">
          Loading inbox…
          <div style="margin-top:12px;display:grid;gap:10px;">
            <div style="height:64px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--line)"></div>
            <div style="height:64px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--line)"></div>
            <div style="height:64px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--line)"></div>
          </div>
        </div>
      `;
    }

    async function refreshInbox(){
      const e = fullEmail();
      if(!e){ toast("Enter username"); return; }
      if(!API_URL || API_URL.includes("PASTE_YOUR")){ toast("Set API_URL first"); return; }

      loadingList();
      toast("Refreshing…");

      try{
        const url = `${API_URL}?email=${encodeURIComponent(e)}&limit=25&_=${Date.now()}`;
        const res = await fetch(url, { cache: "no-store" });

        const text = await res.text();
        let data;
        try{ data = JSON.parse(text); }
        catch{
          throw new Error("API returned non-JSON (check Apps Script deploy access: Anyone).");
        }

        let arr = [];
        if(Array.isArray(data)) arr = data;
        else if(Array.isArray(data.messages)) arr = data.messages;
        else arr = [];

        // Normalize fields lightly
        arr = arr.map(m => ({
          id: m.id || m.messageId || "",
          from: m.from || "",
          subject: m.subject || "",
          date: m.date || m.receivedAt || "",
          body_html: m.body_html || m.html || "",
          body_plain: m.body_plain || m.plain || m.body || ""
        }));

        // newest first
        arr.sort((a,b) => (new Date(b.date).getTime()||0) - (new Date(a.date).getTime()||0));

        MESSAGES = arr;
        msgCount = arr.length;
        updateStats();

        ACTIVE_INDEX = arr.length ? 0 : -1;

        renderList();
        renderView();

        if(!arr.length) toast("No messages");
        else toast("Loaded ✅");
      }catch(err){
        console.error(err);
        msgList.innerHTML = `<div class="emptyView">Error loading inbox. Try again.</div>`;
        toast("API/Network error");
      }
    }

    // =========================
    // Bind
    // =========================
    btnGen.addEventListener("click", genUsername);
    btnCopy.addEventListener("click", copyEmail);
    btnChange.addEventListener("click", changeEmail);
    btnDelete.addEventListener("click", deleteLocal);
    btnRefresh.addEventListener("click", refreshInbox);

    updateStats();
    renderList();
    renderView();
  </script>
</body>
</html>